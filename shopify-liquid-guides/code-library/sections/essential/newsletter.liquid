<!-- Newsletter Section - Marketing Foundation -->
{%- liquid
  assign unique = section.id | replace: '_', '' | downcase
  assign text_alignment = section.settings.text_alignment
  assign color_scheme = section.settings.color_scheme
  if section.settings.background_image != blank
    assign show_background_image = true
  else
    assign show_background_image = false
  endif
  assign background_color = section.settings.background_color
  assign text_color = section.settings.text_color
  assign button_style = section.settings.button_style
  assign section_padding_top = section.settings.section_padding_top
  assign section_padding_bottom = section.settings.section_padding_bottom
  assign max_width = section.settings.max_width
  assign show_social_icons = section.settings.show_social_icons
  assign enable_gdpr = section.settings.enable_gdpr
  assign placeholder_text = section.settings.placeholder_text | default: 'Enter your email address'
  assign button_text = section.settings.button_text | default: 'Subscribe'
-%}

<section
  id="newsletter-{{ unique }}"
  class="newsletter-section newsletter-{{ unique }} color-scheme-{{ color_scheme }}"
  style="
    padding-top: {{ section_padding_top }}px;
    padding-bottom: {{ section_padding_bottom }}px;
    {% if background_color != blank and show_background_image == false %}
      background-color: {{ background_color }};
    {% endif %}
    {% if text_color != blank %}
      color: {{ text_color }};
    {% endif %}
  "
  data-section-id="{{ section.id }}"
  data-section-type="newsletter"
  aria-labelledby="newsletter-heading-{{ unique }}"
>
  {%- if show_background_image -%}
    <div class="newsletter-background-image">
      {%- assign background_image = section.settings.background_image -%}
      <picture>
        <source
          media="(max-width: 749px)"
          srcset="
            {{ background_image | image_url: width: 375 }} 375w,
            {{ background_image | image_url: width: 750 }} 750w
          "
          sizes="100vw"
        >
        <source
          media="(min-width: 750px)"
          srcset="
            {{ background_image | image_url: width: 990 }} 990w,
            {{ background_image | image_url: width: 1200 }} 1200w,
            {{ background_image | image_url: width: 1500 }} 1500w,
            {{ background_image | image_url: width: 1920 }} 1920w
          "
          sizes="100vw"
        >
        <img
          src="{{ background_image | image_url: width: 1200 }}"
          alt="{{ background_image.alt | escape }}"
          loading="lazy"
          width="{{ background_image.width }}"
          height="{{ background_image.height }}"
          class="newsletter-bg-image"
        >
      </picture>
      {%- if section.settings.overlay_opacity > 0 -%}
        <div
          class="newsletter-overlay"
          style="
            background-color: {{ section.settings.overlay_color | default: '#000000' }};
            opacity: {{ section.settings.overlay_opacity | divided_by: 100.0 }};
          "
        ></div>
      {%- endif -%}
    </div>
  {%- endif -%}

  <div class="newsletter-container" style="max-width: {{ max_width }}px;">
    <div class="newsletter-content text-{{ text_alignment }}">
      {%- if section.settings.heading != blank -%}
        <h2
          id="newsletter-heading-{{ unique }}"
          class="newsletter-heading h2"
        >
          {{ section.settings.heading | escape }}
        </h2>
      {%- endif -%}

      {%- if section.settings.subheading != blank -%}
        <div class="newsletter-subheading rte">
          {{ section.settings.subheading }}
        </div>
      {%- endif -%}

      <form
        action="{{ routes.root_url }}contact#newsletter-{{ unique }}"
        method="post"
        id="newsletter-form-{{ unique }}"
        class="newsletter-form"
        accept-charset="UTF-8"
        data-newsletter-form
        novalidate
      >
        <input type="hidden" name="form_type" value="customer">
        <input type="hidden" name="utf8" value="✓">
        <input type="hidden" name="contact[tags]" value="newsletter">

        <div class="newsletter-form-fields">
          <div class="newsletter-email-wrapper">
            <label for="newsletter-email-{{ unique }}" class="visually-hidden">
              {{ 'general.newsletter.email_placeholder' | t | default: 'Email address' }}
            </label>
            <input
              type="email"
              name="contact[email]"
              id="newsletter-email-{{ unique }}"
              class="newsletter-email-input"
              placeholder="{{ placeholder_text | escape }}"
              autocorrect="off"
              autocapitalize="off"
              autocomplete="email"
              required
              aria-describedby="newsletter-email-error-{{ unique }}"
              data-newsletter-email
            >
            <div
              id="newsletter-email-error-{{ unique }}"
              class="newsletter-error"
              role="alert"
              aria-live="polite"
            ></div>
          </div>

          <button
            type="submit"
            class="newsletter-submit btn btn-{{ button_style }}"
            name="commit"
            id="newsletter-submit-{{ unique }}"
            aria-describedby="newsletter-submit-error-{{ unique }}"
            data-newsletter-submit
          >
            <span class="btn-text">{{ button_text | escape }}</span>
            <span class="btn-loading" style="display: none;" aria-hidden="true">
              <svg class="spinner" width="20" height="20" viewBox="0 0 20 20" aria-hidden="true">
                <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="31.416" stroke-dashoffset="31.416">
                  <animate attributeName="stroke-dasharray" dur="1s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
                  <animate attributeName="stroke-dashoffset" dur="1s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
                </circle>
              </svg>
            </span>
          </button>
        </div>

        {%- if enable_gdpr -%}
          <div class="newsletter-gdpr">
            <label class="newsletter-checkbox-label">
              <input
                type="checkbox"
                name="contact[accepts_marketing]"
                id="newsletter-gdpr-{{ unique }}"
                class="newsletter-checkbox"
                required
                data-newsletter-gdpr
              >
              <span class="newsletter-checkmark"></span>
              <span class="newsletter-gdpr-text">
                {{ section.settings.gdpr_text | default: 'I agree to receive marketing emails and understand I can unsubscribe at any time.' }}
              </span>
            </label>
          </div>
        {%- endif -%}

        <div
          id="newsletter-submit-error-{{ unique }}"
          class="newsletter-error"
          role="alert"
          aria-live="polite"
        ></div>

        <div
          id="newsletter-success-{{ unique }}"
          class="newsletter-success"
          role="alert"
          aria-live="polite"
          style="display: none;"
        >
          {{ section.settings.success_message | default: 'Thank you for subscribing! Welcome to our community.' | escape }}
        </div>
      </form>

      {%- if show_social_icons -%}
        <div class="newsletter-social">
          <p class="newsletter-social-heading">{{ section.settings.social_heading | default: 'Follow us' | escape }}</p>
          <ul class="newsletter-social-list" role="list">
            {%- if settings.social_facebook_link != blank -%}
              <li class="newsletter-social-item">
                <a
                  href="{{ settings.social_facebook_link }}"
                  class="newsletter-social-link"
                  aria-label="{{ 'general.social.facebook' | t | default: 'Facebook' }}"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                  </svg>
                </a>
              </li>
            {%- endif -%}
            {%- if settings.social_instagram_link != blank -%}
              <li class="newsletter-social-item">
                <a
                  href="{{ settings.social_instagram_link }}"
                  class="newsletter-social-link"
                  aria-label="{{ 'general.social.instagram' | t | default: 'Instagram' }}"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                  </svg>
                </a>
              </li>
            {%- endif -%}
            {%- if settings.social_twitter_link != blank -%}
              <li class="newsletter-social-item">
                <a
                  href="{{ settings.social_twitter_link }}"
                  class="newsletter-social-link"
                  aria-label="{{ 'general.social.twitter' | t | default: 'Twitter' }}"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                  </svg>
                </a>
              </li>
            {%- endif -%}
            {%- if settings.social_youtube_link != blank -%}
              <li class="newsletter-social-item">
                <a
                  href="{{ settings.social_youtube_link }}"
                  class="newsletter-social-link"
                  aria-label="{{ 'general.social.youtube' | t | default: 'YouTube' }}"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                  </svg>
                </a>
              </li>
            {%- endif -%}
          </ul>
        </div>
      {%- endif -%}
    </div>
  </div>
</section>

<style>
/* Newsletter Section - {{ unique }} */
.newsletter-{{ unique }} {
  position: relative;
  isolation: isolate;
}

.newsletter-{{ unique }} .newsletter-container {
  width: 100%;
  margin: 0 auto;
  padding: 0 20px;
}

.newsletter-{{ unique }} .newsletter-content {
  position: relative;
  z-index: 2;
}

/* Background Image */
.newsletter-{{ unique }} .newsletter-background-image {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
}

.newsletter-{{ unique }} .newsletter-bg-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center;
}

.newsletter-{{ unique }} .newsletter-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1;
}

/* Typography */
.newsletter-{{ unique }} .newsletter-heading {
  margin: 0 0 16px 0;
  font-size: clamp(28px, 4vw, 48px);
  line-height: 1.2;
  font-weight: 700;
}

.newsletter-{{ unique }} .newsletter-subheading {
  margin: 0 0 32px 0;
  font-size: 18px;
  line-height: 1.5;
  opacity: 0.9;
}

/* Form Styling */
.newsletter-{{ unique }} .newsletter-form {
  max-width: 500px;
  margin: 0 auto;
}

.newsletter-{{ unique }} .newsletter-form-fields {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}

.newsletter-{{ unique }} .newsletter-email-wrapper {
  flex: 1;
  position: relative;
}

.newsletter-{{ unique }} .newsletter-email-input {
  width: 100%;
  padding: 16px 20px;
  border: 2px solid rgba(0, 0, 0, 0.1);
  border-radius: 6px;
  font-size: 16px;
  background: white;
  transition: all 0.3s ease;
}

.newsletter-{{ unique }} .newsletter-email-input:focus {
  outline: none;
  border-color: var(--color-primary, #007bff);
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.newsletter-{{ unique }} .newsletter-email-input::placeholder {
  color: rgba(0, 0, 0, 0.6);
}

.newsletter-{{ unique }} .newsletter-submit {
  padding: 16px 24px;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
  min-width: 120px;
  justify-content: center;
}

.newsletter-{{ unique }} .newsletter-submit:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.newsletter-{{ unique }} .newsletter-submit:active {
  transform: translateY(0);
}

.newsletter-{{ unique }} .newsletter-submit.loading .btn-text {
  opacity: 0;
}

.newsletter-{{ unique }} .newsletter-submit.loading .btn-loading {
  display: block !important;
  position: absolute;
}

/* Button Styles */
.newsletter-{{ unique }} .btn-primary {
  background: var(--color-primary, #007bff);
  color: white;
}

.newsletter-{{ unique }} .btn-secondary {
  background: var(--color-secondary, #6c757d);
  color: white;
}

.newsletter-{{ unique }} .btn-outline {
  background: transparent;
  color: var(--color-primary, #007bff);
  border: 2px solid var(--color-primary, #007bff);
}

/* GDPR Checkbox */
.newsletter-{{ unique }} .newsletter-gdpr {
  margin-bottom: 16px;
}

.newsletter-{{ unique }} .newsletter-checkbox-label {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  cursor: pointer;
  font-size: 14px;
  line-height: 1.4;
}

.newsletter-{{ unique }} .newsletter-checkbox {
  position: absolute;
  opacity: 0;
  cursor: pointer;
}

.newsletter-{{ unique }} .newsletter-checkmark {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(0, 0, 0, 0.3);
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  flex-shrink: 0;
  margin-top: 2px;
}

.newsletter-{{ unique }} .newsletter-checkbox:checked + .newsletter-checkmark {
  background: var(--color-primary, #007bff);
  border-color: var(--color-primary, #007bff);
}

.newsletter-{{ unique }} .newsletter-checkbox:checked + .newsletter-checkmark::after {
  content: '✓';
  color: white;
  font-size: 12px;
  font-weight: bold;
}

.newsletter-{{ unique }} .newsletter-checkbox:focus + .newsletter-checkmark {
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

/* Messages */
.newsletter-{{ unique }} .newsletter-error {
  color: #dc3545;
  font-size: 14px;
  margin-top: 8px;
  display: none;
}

.newsletter-{{ unique }} .newsletter-error.show {
  display: block;
}

.newsletter-{{ unique }} .newsletter-success {
  background: #d4edda;
  color: #155724;
  padding: 16px;
  border-radius: 6px;
  font-size: 16px;
  text-align: center;
  margin-top: 16px;
  border: 1px solid #c3e6cb;
}

/* Social Icons */
.newsletter-{{ unique }} .newsletter-social {
  margin-top: 32px;
  text-align: center;
}

.newsletter-{{ unique }} .newsletter-social-heading {
  margin: 0 0 16px 0;
  font-size: 14px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  opacity: 0.8;
}

.newsletter-{{ unique }} .newsletter-social-list {
  display: flex;
  justify-content: center;
  gap: 16px;
  list-style: none;
  margin: 0;
  padding: 0;
}

.newsletter-{{ unique }} .newsletter-social-link {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.1);
  color: inherit;
  transition: all 0.3s ease;
  text-decoration: none;
}

.newsletter-{{ unique }} .newsletter-social-link:hover {
  background: var(--color-primary, #007bff);
  color: white;
  transform: translateY(-2px);
}

/* Color Schemes */
.newsletter-{{ unique }}.color-scheme-light {
  background: #ffffff;
  color: #333333;
}

.newsletter-{{ unique }}.color-scheme-dark {
  background: #1a1a1a;
  color: #ffffff;
}

.newsletter-{{ unique }}.color-scheme-dark .newsletter-email-input {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.2);
  color: white;
}

.newsletter-{{ unique }}.color-scheme-dark .newsletter-email-input::placeholder {
  color: rgba(255, 255, 255, 0.6);
}

.newsletter-{{ unique }}.color-scheme-dark .newsletter-checkmark {
  border-color: rgba(255, 255, 255, 0.3);
}

/* Text Alignment */
.newsletter-{{ unique }} .text-left {
  text-align: left;
}

.newsletter-{{ unique }} .text-center {
  text-align: center;
}

.newsletter-{{ unique }} .text-right {
  text-align: right;
}

/* Responsive Design */
@media (max-width: 749px) {
  .newsletter-{{ unique }} .newsletter-container {
    padding: 0 16px;
  }

  .newsletter-{{ unique }} .newsletter-form-fields {
    flex-direction: column;
    gap: 16px;
  }

  .newsletter-{{ unique }} .newsletter-submit {
    width: 100%;
    justify-content: center;
  }

  .newsletter-{{ unique }} .newsletter-social-list {
    gap: 12px;
  }

  .newsletter-{{ unique }} .newsletter-heading {
    font-size: clamp(24px, 6vw, 32px);
  }

  .newsletter-{{ unique }} .newsletter-subheading {
    font-size: 16px;
    margin-bottom: 24px;
  }
}

@media (max-width: 480px) {
  .newsletter-{{ unique }} .newsletter-container {
    padding: 0 12px;
  }

  .newsletter-{{ unique }} .newsletter-email-input,
  .newsletter-{{ unique }} .newsletter-submit {
    padding: 14px 16px;
    font-size: 16px; /* Prevents zoom on iOS */
  }
}

/* Loading Animation */
.newsletter-{{ unique }} .spinner {
  animation: newsletter-spin-{{ unique }} 1s linear infinite;
}

@keyframes newsletter-spin-{{ unique }} {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Accessibility */
.newsletter-{{ unique }} .visually-hidden {
  position: absolute !important;
  width: 1px !important;
  height: 1px !important;
  padding: 0 !important;
  margin: -1px !important;
  overflow: hidden !important;
  clip: rect(0, 0, 0, 0) !important;
  white-space: nowrap !important;
  border: 0 !important;
}

/* Focus styles for keyboard navigation */
.newsletter-{{ unique }} .newsletter-email-input:focus,
.newsletter-{{ unique }} .newsletter-submit:focus,
.newsletter-{{ unique }} .newsletter-checkbox:focus + .newsletter-checkmark,
.newsletter-{{ unique }} .newsletter-social-link:focus {
  outline: 2px solid var(--color-primary, #007bff);
  outline-offset: 2px;
}

/* High contrast mode */
@media (prefers-contrast: high) {
  .newsletter-{{ unique }} .newsletter-email-input {
    border-width: 3px;
  }

  .newsletter-{{ unique }} .newsletter-checkmark {
    border-width: 3px;
  }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  .newsletter-{{ unique }} * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
</style>

<script>
(function() {
  'use strict';

  const sectionId = '{{ unique }}';
  const form = document.getElementById(`newsletter-form-${sectionId}`);
  const emailInput = document.querySelector(`[data-newsletter-email]`);
  const submitButton = document.querySelector(`[data-newsletter-submit]`);
  const gdprCheckbox = document.querySelector(`[data-newsletter-gdpr]`);

  if (!form) return;

  // Email validation
  function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }

  // Show error message
  function showError(inputElement, message) {
    const errorElement = document.getElementById(inputElement.getAttribute('aria-describedby'));
    if (errorElement) {
      errorElement.textContent = message;
      errorElement.classList.add('show');
    }
  }

  // Hide error message
  function hideError(inputElement) {
    const errorElement = document.getElementById(inputElement.getAttribute('aria-describedby'));
    if (errorElement) {
      errorElement.textContent = '';
      errorElement.classList.remove('show');
    }
  }

  // Show success message
  function showSuccess() {
    const successElement = document.getElementById(`newsletter-success-${sectionId}`);
    if (successElement) {
      successElement.style.display = 'block';
      form.style.display = 'none';
    }
  }

  // Set loading state
  function setLoadingState(loading) {
    submitButton.classList.toggle('loading', loading);
    submitButton.disabled = loading;
    emailInput.disabled = loading;
    if (gdprCheckbox) gdprCheckbox.disabled = loading;
  }

  // Real-time email validation
  emailInput.addEventListener('input', function() {
    const email = this.value.trim();
    if (email && !validateEmail(email)) {
      showError(this, 'Please enter a valid email address');
    } else {
      hideError(this);
    }
  });

  // Form submission
  form.addEventListener('submit', function(e) {
    e.preventDefault();

    const email = emailInput.value.trim();
    let isValid = true;

    // Clear previous errors
    hideError(emailInput);
    hideError(submitButton);

    // Validate email
    if (!email) {
      showError(emailInput, 'Email address is required');
      isValid = false;
    } else if (!validateEmail(email)) {
      showError(emailInput, 'Please enter a valid email address');
      isValid = false;
    }

    // Validate GDPR checkbox if enabled
    if (gdprCheckbox && !gdprCheckbox.checked) {
      showError(submitButton, 'Please agree to receive marketing emails');
      isValid = false;
    }

    if (!isValid) {
      emailInput.focus();
      return;
    }

    // Set loading state
    setLoadingState(true);

    // Submit form
    const formData = new FormData(form);

    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => {
      if (response.ok) {
        showSuccess();

        // Analytics tracking (if available)
        if (typeof gtag !== 'undefined') {
          gtag('event', 'newsletter_signup', {
            'event_category': 'engagement',
            'event_label': 'newsletter'
          });
        }

        // Facebook Pixel (if available)
        if (typeof fbq !== 'undefined') {
          fbq('track', 'Subscribe');
        }
      } else {
        throw new Error('Network response was not ok');
      }
    })
    .catch(error => {
      console.error('Newsletter signup error:', error);
      showError(submitButton, 'Something went wrong. Please try again.');
    })
    .finally(() => {
      setLoadingState(false);
    });
  });

  // Keyboard accessibility for custom checkbox
  if (gdprCheckbox) {
    gdprCheckbox.addEventListener('keydown', function(e) {
      if (e.key === ' ') {
        e.preventDefault();
        this.checked = !this.checked;
      }
    });
  }
})();
</script>

{% schema %}
{
  "name": "Newsletter",
  "tag": "section",
  "class": "section-newsletter",
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ]
  },
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Stay in the loop"
    },
    {
      "type": "richtext",
      "id": "subheading",
      "label": "Subheading",
      "default": "<p>Subscribe to our newsletter for exclusive offers, new arrivals, and style inspiration delivered straight to your inbox.</p>"
    },
    {
      "type": "text",
      "id": "placeholder_text",
      "label": "Email placeholder text",
      "default": "Enter your email address"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Subscribe"
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success message",
      "default": "Thank you for subscribing! Welcome to our community."
    },
    {
      "type": "header",
      "content": "GDPR & Privacy"
    },
    {
      "type": "checkbox",
      "id": "enable_gdpr",
      "label": "Enable GDPR consent checkbox",
      "default": false,
      "info": "Required in EU for marketing emails"
    },
    {
      "type": "textarea",
      "id": "gdpr_text",
      "label": "GDPR consent text",
      "default": "I agree to receive marketing emails and understand I can unsubscribe at any time.",
      "info": "Only shown when GDPR is enabled"
    },
    {
      "type": "header",
      "content": "Social Media"
    },
    {
      "type": "checkbox",
      "id": "show_social_icons",
      "label": "Show social media icons",
      "default": true,
      "info": "Uses social media links from theme settings"
    },
    {
      "type": "text",
      "id": "social_heading",
      "label": "Social media heading",
      "default": "Follow us"
    },
    {
      "type": "header",
      "content": "Design"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color scheme",
      "options": [
        {
          "value": "light",
          "label": "Light"
        },
        {
          "value": "dark",
          "label": "Dark"
        }
      ],
      "default": "light"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "info": "Overrides color scheme background"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "info": "Overrides color scheme text color"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Text alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button style",
      "options": [
        {
          "value": "primary",
          "label": "Primary"
        },
        {
          "value": "secondary",
          "label": "Secondary"
        },
        {
          "value": "outline",
          "label": "Outline"
        }
      ],
      "default": "primary"
    },
    {
      "type": "header",
      "content": "Background Image"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background image"
    },
    {
      "type": "color",
      "id": "overlay_color",
      "label": "Overlay color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "Overlay opacity",
      "min": 0,
      "max": 80,
      "step": 5,
      "unit": "%",
      "default": 30
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "max_width",
      "label": "Maximum width",
      "min": 600,
      "max": 1200,
      "step": 50,
      "unit": "px",
      "default": 800
    },
    {
      "type": "range",
      "id": "section_padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "default": 60
    },
    {
      "type": "range",
      "id": "section_padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "default": 60
    }
  ],
  "presets": [
    {
      "name": "Newsletter signup",
      "settings": {
        "heading": "Stay in the loop",
        "subheading": "<p>Subscribe to our newsletter for exclusive offers, new arrivals, and style inspiration delivered straight to your inbox.</p>",
        "text_alignment": "center",
        "color_scheme": "light",
        "button_style": "primary",
        "show_social_icons": true,
        "enable_gdpr": false,
        "section_padding_top": 60,
        "section_padding_bottom": 60
      }
    }
  ]
}
{% endschema %}